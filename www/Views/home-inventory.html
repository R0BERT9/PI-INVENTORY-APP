<div class="bg-fc2">
    <div class="flex flex-col gap-4 py-14 w-11/12 m-auto -my-4">
        <h2 id="greeting" class="font-bold text-3xl text-white">Hola, <span id="user-name-placeholder">User</span></h2>
        <p class="font-medium text-xl text-white">Bienvenido a tu inventario</p>
    </div>
</div>

<div class="py-8 -mt-14  w-[90%] m-auto">
    <div class="flex items-center bg-white shadow-md rounded-md py-2 px-5" >
        <button><img class="w-5" src="Public/assets/bx-search.svg" alt=""></button>
        <input type="text" placeholder="Search Products" class="flex-grow py-2 px-4 focus:outline-none"  onclick="hideNavBar()" onblur="showNavBar()">
        <button><img class="w-9" src="Public/assets/bx-scan-qr.svg" alt=""></button>
    </div>
</div>

<div class="gap-6 flex flex-col mb-20">
    <div class="flex justify-between w-11/12 m-auto">
        <h2 class="font-bold text-xl text-fc2">Productos Recientes</h2>
        <p class="view-see-products font-bold text-[#888888]">Ver Todos</p>
    </div>

    <div id="recent-products-container" class="w-4/5 m-auto flex flex-col gap-4 overflow-y-auto"></div>
</div>


<div id="details-container" class="flex flex-col w-[90%] gap-10 m-auto mt-10 hidden mb-10"> <!-- Div principal utilizo el 90% de la pantalla -->
    <div class="flex gap-2 view-back">
        <button id="back-button"><img src="Public/assets/bx-arrow-back.svg" alt=""></button>
        <h3 class="font-bold">Atrás</h3>
    </div>

    <div class="w-[85%] m-auto flex flex-col gap-7">
        <div class="flex gap-5 justify-between items-end">
            <div class="gap-1 flex flex-col">
                <h3 class="text-fc2 font-bold text-3xl">Detalles</h3>
                <div class="flex-grow border-t border-fc3"></div>
            </div>
        </div>

        <div class="bg-[#EEF2FF] p-4 rounded-md flex flex-col gap-2">   
            <img id="product-image" class="rounded-md object-cover flex justify-center items-center max-h-36 w-full"> 
            
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="product-title" class="font-semibold"></h1>
                    <p id="product-quantity" class="text-sm"></p>
                </div>
                <div class="flex gap-2 items-center">
                    <img src="Public/assets/calendar-month.svg" alt="">
                    <p id="product-date" class="text-[#757575] text-sm"></p>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <h2 id="product-name" class="font-bold text-lg"></h2>
            <p id="product-description" class="text-sm"></p>
        </div>
     
        <div class="flex flex-col gap-3">
            <div id="map-container" style="height: 150px; width: 100%;">
                <div id="map" style="height: 100%;" class="rounded-md"></div>
            </div>
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="font-semibold" id="city-state">Ubicación</h2>
                    <p class="text-sm" id="location-address"></p>
                </div>
                <button id="view-map-button" class="px-3 py-1 bg-fc3 rounded-md text-white font-semibold">Ver en Mapa</button>
            </div>
        </div>
    </div>
</div>


<script>  
function updateGreeting(userName) {
    const greetingElement = document.getElementById('greeting');
    const userNameElement = document.getElementById('user-name-placeholder');
    userNameElement.textContent = userName;
    greetingElement.textContent = `Hola, ${userName}`;
    console.log('Nombre del usuario:', userName);
}

firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        const userEmail = user.email;

        if (!localStorage.getItem('hasLoggedIn')) {
            Swal.fire({
                title: 'Cargando...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                    const swalElm = Swal.getPopup();
                    swalElm.classList.add('bg-white', 'border', 'border-blue-500', 'rounded-md', 'shadow-lg', 'w-80');
                    const spinner = swalElm.querySelector('.swal2-loader');
                    pinner.style.borderRightColor = '#1E40AF';
                }
            });

            db.collection('Usuarios').where('email', '==', userEmail).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const userName = doc.data().fullName || 'User';
                    updateGreeting(userName);
                });
            }).catch((error) => {
                console.error('Error obteniendo documentos:', error);
            }).finally(() => {
                Swal.close();
                localStorage.setItem('hasLoggedIn', true);
            });
        } else {
            db.collection('Usuarios').where('email', '==', userEmail).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const userName = doc.data().fullName || 'User';
                    updateGreeting(userName);
                });
            }).catch((error) => {
                console.error('Error obteniendo documentos:', error);
            });
        }
    }
});

document.querySelector('.view-see-products').addEventListener('click',function(){
loadPartialView('products',document.querySelector('.init'), false);
})

    function showRecentProducts() {
        const user = auth.currentUser;

        if (user) {
            const recentProductsContainer = document.getElementById('recent-products-container');

            db.collection('Usuarios').doc(user.uid).collection('Products')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    recentProductsContainer.innerHTML = ""; // Limpiar el contenedor antes de mostrar los nuevos productos
                    snapshot.forEach(doc => {
                        const productData = doc.data();
                        const productName = productData.itemName;
                        const productImage = productData.image;
                        const productDate = productData.date;
                        const productQuantity = productData.quantity;

                        // Crear la tarjeta del producto
                        const productCard = document.createElement('div');
                        productCard.classList.add('w-full', 'bg-[#eef2ff]', 'flex', 'p-3', 'rounded-xl', 'gap-4');

                        productCard.innerHTML = `
                            <div class="w-1/5 bg-white rounded-2xl items-center flex">
                                <img src="${productImage}" alt="${productName}">
                            </div>
                            <div>
                                <h3 class="text-[#333333] font-medium">${productName}</h3>
                                <p class="text-[#333333] text-xs">Date: ${productDate}</p>
                                <p class="text-[#333333] text-xs">Qty: ${productQuantity}</p>
                            </div>
                        `;

                        recentProductsContainer.appendChild(productCard);
                    });

                    // Mostrar una imagen cuando no hay productos recientes
                    if (snapshot.empty) {
                        recentProductsContainer.innerHTML = `
                            <div class="flex justify-center items-center">
                                <img src="Public/assets/box-empty.png" alt="No items" class="w-[75%]">
                            </div>
                        `;
                    }
                });
        } else {
            console.log('No user is signed in');
        }
    }

    showRecentProducts();
</script>
